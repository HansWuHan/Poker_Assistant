# 调试功能使用指南

## 功能概述

项目现已集成完整的 API 调试功能，可以详细查看：
- 🔍 每次 API 请求的完整参数
- 📝 发送给 AI 的完整 Prompt 内容
- 📤 API 响应的详细信息（耗时、Token 使用、结束原因）
- 📊 AI 的完整回复内容

## 快速启用

### 方法 1: 环境变量（推荐）

在 `.env` 文件中添加：

```bash
# 启用调试模式
DEBUG=true
```

然后正常运行游戏：

```bash
python3 main.py
```

### 方法 2: 临时启用

在命令行中临时设置：

```bash
export DEBUG=true
python3 main.py
```

### 方法 3: 测试脚本

使用专门的调试测试脚本：

```bash
# 单场景测试
python3 test_debug.py

# 多场景测试
python3 test_game_with_debug.py
```

## 调试信息解读

### 请求信息

```
======================================================================
🔍 Deepseek API 调试信息
======================================================================
📋 请求参数:
  Model: deepseek-chat
  Temperature: 0.7
  Max Tokens: 1000
  Messages 数量: 1
```

**说明**：
- `Model`: 使用的模型名称
- `Temperature`: 随机性参数（0.7 = 平衡创造性和稳定性）
- `Max Tokens`: 最大输出长度限制
- `Messages 数量`: 发送的消息数量（通常为 1）

### 请求内容

```
📝 请求内容:
  Message 1 [user]:
  ------------------------------------------------------------
  你是一位经验丰富的德州扑克教练...
  [完整的 Prompt 内容]
```

**说明**：
- 显示发送给 AI 的完整 Prompt
- 如果内容超过 500 字符，会自动截取显示并标注总长度
- 可以检查 Prompt 是否正确包含了所有游戏信息

### 响应信息

```
📤 API 响应:
  耗时: 7.95 秒
  Tokens 使用: 458 (输入) + 193 (输出) = 651
  结束原因: stop
```

**关键指标**：

1. **耗时**：API 调用时间
   - 正常范围：5-15 秒
   - 如果超过 20 秒，可能网络有问题

2. **Tokens 使用**：
   - `输入 tokens`: Prompt 的长度
   - `输出 tokens`: AI 回复的长度
   - `总计`: 计费依据

3. **结束原因**（最重要）：
   - ✅ `stop`: 正常结束，AI 认为回答完整
   - ⚠️ `length`: 达到 max_tokens 限制被截断
   - 🔧 如果经常出现 `length`，需要增加 max_tokens

### 响应内容

```
📝 响应内容 (长度: 320 字符):
  ------------------------------------------------------------
  [AI 的完整回复]
======================================================================
```

**说明**：
- 显示 AI 的完整回复内容
- 标注内容长度
- 如果结束原因是 `length` 且内容不完整，这里会显示警告

## 常见问题排查

### 问题 1: 输出不完整，以 "..." 结束

**症状**：
```
结束原因: length
⚠️  警告: 输出因达到 max_tokens 限制而截断！
```

**解决方案**：
增加相应模块的 `max_tokens`：

```python
# 在对应的分析引擎中
response = self.llm_client.chat(
    messages, 
    temperature=0.7, 
    max_tokens=1500  # 原来是 1000，增加到 1500
)
```

### 问题 2: API 调用失败

**症状**：
```
❌ API 调用失败: [错误信息]
```

**检查项**：
1. API Key 是否正确配置
2. 网络连接是否正常
3. API 余额是否充足

### 问题 3: AI 理解错误

**症状**：
- AI 把一对 A 说成三条 A
- AI 没有识别出同花听牌

**排查步骤**：
1. 查看 `📝 请求内容`，确认 Prompt 是否正确
2. 检查手牌和公共牌的格式是否正确
3. 查看 AI 的完整回复，判断哪里理解错误
4. 优化 Prompt 模板，添加更明确的规则说明

## Token 使用统计

不同场景的典型 Token 使用量：

| 场景 | 输入 Tokens | 输出 Tokens | 总计 | 耗时 |
|------|------------|-------------|------|------|
| 翻牌前建议 | ~400 | ~200 | ~600 | 5-8s |
| 翻牌圈建议 | ~450 | ~200 | ~650 | 6-9s |
| 转牌圈建议 | ~500 | ~250 | ~750 | 7-10s |
| 河牌圈建议 | ~550 | ~250 | ~800 | 8-11s |
| 牌面分析 | ~300 | ~150 | ~450 | 4-7s |
| 对手分析 | ~400 | ~180 | ~580 | 5-8s |

**成本估算**（以 Deepseek 为例）：
- 价格：约 $0.001 / 1K tokens
- 一局完整游戏（4 个阶段）：约 2500 tokens = $0.0025
- 100 局游戏成本：约 $0.25

## 性能优化建议

### 开发阶段
```bash
# 启用调试，详细排查问题
DEBUG=true
```

### 生产环境
```bash
# 关闭调试，提升性能
DEBUG=false  # 或不设置
```

### 选择性调试

如果只想调试某个特定模块，可以在代码中临时启用：

```python
# 在特定的分析引擎中
debug_mode = True  # 临时启用
response = self.llm_client.chat(
    messages, 
    temperature=0.7, 
    max_tokens=1000,
    debug=debug_mode  # 显式传递
)
```

## 日志保存

调试信息会直接输出到终端。如果需要保存日志：

```bash
# 保存到文件
python3 main.py 2>&1 | tee game_debug.log

# 只保存调试部分
python3 main.py 2>&1 | grep -A 50 "🔍 Deepseek API" > api_debug.log
```

## 相关文件

- `/poker_assistant/llm_service/deepseek_client.py` - API 客户端（调试功能实现）
- `/poker_assistant/ai_analysis/*.py` - 各分析引擎（启用调试开关）
- `test_debug.py` - 单场景调试测试
- `test_game_with_debug.py` - 多场景调试测试
- `API_OPTIMIZATION.md` - API 优化详细文档

## 示例输出

完整的调试输出示例：

```
======================================================================
🔍 Deepseek API 调试信息
======================================================================
📋 请求参数:
  Model: deepseek-chat
  Temperature: 0.7
  Max Tokens: 1000
  Messages 数量: 1

📝 请求内容:
  Message 1 [user]:
  ------------------------------------------------------------
  你是一位经验丰富的德州扑克教练。请仔细分析以下牌局并给出专业建议。
  
  【德州扑克规则提醒】
  - 你的手牌：2 张底牌（只有你看得到）
  - 公共牌：桌面上的牌（所有人共享）
  ...
  
======================================================================
📤 API 响应:
  耗时: 7.95 秒
  Tokens 使用: 458 (输入) + 204 (输出) = 662
  结束原因: stop

📝 响应内容 (长度: 320 字符):
  ------------------------------------------------------------
  **【牌型识别】**  
  手牌A♠A♥ + 公共牌Q♥7♦2♣ → **顶对AA**（当前最强牌型）。
  
  **【牌力评估】**  
  **强度极高**：翻牌面干燥...
  
  **【推荐行动】**  
  **加注$60-$120**。理由：...
  
  **【风险提示】**  
  警惕唯一风险：对手持有**QQ**...
  
  **总结**：牌面优势明显，应主动加注建立底池。
======================================================================
```

## 总结

调试功能可以帮助你：
1. ✅ 排查 AI 输出不完整的问题
2. ✅ 监控 API 调用的性能和成本
3. ✅ 验证 Prompt 是否正确传递
4. ✅ 理解 AI 的推理过程
5. ✅ 优化 Token 使用效率

建议在开发和测试阶段充分利用调试功能！

